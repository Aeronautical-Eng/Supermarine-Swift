<system  name="FCS F15">
<!-- F-104G Flight controls 
    Author: Richard Harrison (rjh@zaretto.com)
    References: 
-->
    <property value="1">fcs/ari-lateral-enabled</property>
    <property value="1">gear/serviceable</property>
    <property value="0">gear/emergency-handle</property>
    <property value="0">malfunctions/fcs/pitch-trim-inop</property>
    <property value="0">malfunctions/fcs/roll-trim-actuator-norm-inop</property>
    <property value="0">malfunctions/fcs/aileron-actuator-inop</property>
    <property value="0">malfunctions/fcs/rudder-actuator-inop</property>
    <property value="1">fcs/pitch-ratio</property>
    <property value="1">systems/cadc/rudder-effectivity</property>
    <property value="1">systems/cadc/aileron-effectivity</property>
    <property value="0">gear/gear-asym</property>
    <property value="0">fcs/yaw-damper-enable</property>
    <property value="0">fcs/pitch-damper-enable</property>
    <property value="0">fcs/aim-fitted</property>
    <property value="0">fcs/steer-maneuver</property>
    <property>systems/NWS/engaged</property>
    <property v="1">a/debug</property>
    <property v="0">a/metric_forces</property>
    <property v="0">a/metric_moments</property>

    <property>fcs/hook-engage</property>
    <property>fcs/roll-trim-sas-cmd-norm</property>

    <channel name="Auxiliary">
        <pure_gain name="Pilot G">
            <input>accelerations/n-pilot-z-norm</input>
            <gain>-1</gain>
            <output>/accelerations/pilot-gdamped</output>
        </pure_gain>
        
        <pure_gain name="aero/alphadot-rad_sec-limited">
            <input>aero/alphadot-rad_sec</input>
            <output>aero/alphadot-rad_sec-limited</output>
            <gain>1</gain>
            <clipto>
                <min> -0.2</min>
                <max> 0.2</max>
            </clipto>
        </pure_gain>
        <pure_gain name="aero/betadot-rad_sec-limited">
            <input>aero/betadot-rad_sec</input>
            <output>aero/betadot-rad_sec-limited</output>
            <gain>1</gain>
            <clipto>
                <min> -0.1</min>
                <max> 0.1</max>
            </clipto>
        </pure_gain>

        <switch name="position/aircraft-on-ground">
            <description>Aircraft on ground</description>
            <default value="0"/>
            <test value="1" logic="OR">
                gear/unit[0]/WOW ne 0
                gear/unit[1]/WOW ne 0
                gear/unit[2]/WOW ne 0
            </test>
        </switch>
        <fcs_function name="aero/alpha-indicated-deg">
            <description>ARI nose probe; ref ADA101648 p84; alpha_true = .8122 alphaNOSEPROBE + .797deg</description>
            <function>
                <product>
                    <sum>
                        <property> aero/alpha-deg </property>
                        <value> -0.797 </value>
                    </sum>
                    <value>1.231223836</value>
                </product>
            </function>
        </fcs_function>
        <!--<fcs_function name="aero/aero-rp-x-in">
            <function>
                <description>Centre of pressure due to mach</description>
                <sum>
                    <table>
                        <independentVar lookup="row">velocities/mach</independentVar>
                        <tableData>
                            0.00    419
                            2.4     445
                        </tableData>
                    </table>
                </sum>
            </function>
            <output>metrics/aero-rp-x-in</output>
        </fcs_function>-->

    </channel>

    <channel name="SoundFX">
        <fcs_function name="fcs/flap-windfx-volume">
            <function>
                <product>
                    <property>velocities/ve-kts</property>
                    <property>fcs/flap-pos-norm</property>
                </product>
            </function>
            <output>fcs/flap-windfx-volume</output>
        </fcs_function>
        <fcs_function name="fcs/gear-windfx-volume">
            <function>
                <product>
                    <property>velocities/ve-kts</property>
                    <property>fcs/gear-control</property>
                </product>
            </function>
            <output>fcs/gear-windfx-volume</output>
        </fcs_function>
    </channel>


    <channel name="Pitch">
        <summer name="fcs/pitch-trim-sum-norm">
            <input>fcs/elevator-cmd-norm</input>
            <input>fcs/pitch-trim-cmd-norm</input>
            <clipto>
                <min> -1 </min>
                <max>  1 </max>
            </clipto>
        </summer>

        <switch name="fcs/pitch-trim-actuator-norm">
            <default value="fcs/pitch-trim-sum-norm"/>
            <!--<test value="fcs/pitch-trim-actuator-norm">
                systems/hydraulics/system-pressure eq 0
            </test>-->
        </switch>

        <fcs_function name="fcs/elevator-pos-demand-rad">
            <description>Calculate the elevator position in radians based on the inputs</description>
            <function>
                <product>
                    <property>fcs/pitch-trim-actuator-norm</property>
                    <property>fcs/pitch-ratio</property>
                    <v>0.523599</v>
                    <v>-1</v> <!-- need to negate to match aero data-->
                </product>
            </function>
        </fcs_function>

        <kinematic name="fcs/elevator-pos-rad">
            <input>fcs/elevator-pos-demand-rad</input>
            <traverse>
                <setting>
                    <position>-1</position>
                    <time>0.9</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>0.90</time>
                    <!-- based on 30 deg/sec -->
                </setting>
            </traverse>
        </kinematic>

        <aerosurface_scale name="fcs/elevator-pos-norm">
            <input>fcs/elevator-pos-rad</input>
            <domain>
                <min>  -0.34906 </min>
                <max>   0.34906 </max>
            </domain>
            <range>
                <min> -1 </min>
                <max>  1 </max>
            </range>
        </aerosurface_scale>
    </channel>
    <!-- aileron: +/- 12.5deg : +/- 33 deg/sec -->
    <channel name="Roll">
        <summer name="fcs/roll-trim-sum-norm-raw">
            <input>fcs/aileron-cmd-norm</input>
            <input>fcs/roll-trim-cmd-norm</input>
            <!--<input>fcs/roll-trim-sas-cmd-norm</input>
            <input>fcs/roll-rate-limiter</input>-->
            <clipto>
                <min> -1 </min>
                <max>  1 </max>
            </clipto>
        </summer>

        <fcs_function>
            <function>
                <sum>
                    <property>fcs/roll-trim-cmd-norm</property>
                    <product>
                        <min>
                            <max>
                                <product>
                                    <sum>
                                        <p>fcs/aileron-cmd-norm</p>
                                        <p>fcs/roll-trim-cmd-norm</p>
                                    </sum>
                                    <p>systems/cadc/aileron-effectivity</p>
                                </product>
                                <v>-1</v>
                            </max>
                            <v>1</v>
                        </min>
                        <sum>
                            <product>
                                <p>gear/gear-cmd-norm</p>
                                <v>0.5</v>
                            </product>
                            <v>0.5</v>
                        </sum>
                        <!--<property>fcs/roll-ratio</property>-->
                        <!--<v>-1</v>-->
                    </product>
                </sum>
            </function>
            <clipto>
                <min> -1 </min>
                <max>  1 </max>
            </clipto>
            <output>fcs/aileron-sum</output>
        </fcs_function>


        <switch name="fcs/aileron-actuator-pos">
            <default value="fcs/aileron-sum"/>
            <!--<test value="fcs/aileron-actuator-pos">
                systems/hydraulics/system-pressure eq 0
            </test>-->
            <test value="fcs/aileron-actuator-pos">
                malfunctions/fcs/aileron-actuator-inop ne 0
            </test>
        </switch>
        <kinematic name="Aileron Control">
            <input>fcs/aileron-actuator-pos</input>
            <traverse>
                <setting>
                    <position>-0.35</position>
                    <time>0.90</time>
                    <!-- based on 30 deg/sec -->
                </setting>
                <setting>
                    <position>0.35</position>
                    <time>0.90</time>
                    <!-- based on 30 deg/sec -->
                </setting>
            </traverse>
            <output>fcs/aileron-pos-rad</output>
        </kinematic>

        <aerosurface_scale name="aileron normalization">
            <input>fcs/aileron-pos-rad</input>
            <domain>
                <min> -0.35 </min>
                <max>  0.35 </max>
            </domain>
            <range>
                <min> -1 </min>
                <max>  1 </max>
            </range>
            <output>fcs/aileron-pos-norm</output>
        </aerosurface_scale>
        <pure_gain name="fcs/aileron-pos-deg">
            <input>fcs/aileron-pos-rad</input>
            <gain>57.324</gain>
        </pure_gain >

    </channel>

    <channel name="Yaw">
        <switch name="fcs/yaw-damper-active">
            <default value="0.0"/>
            <test logic="AND" value="1">
                fcs/yaw-damper-enable ne 0.0
            </test>
            <output>fcs/yaw-damper-active</output>
        </switch>

        <scheduled_gain name="fcs/yaw-damper-sum">
            <input>velocities/r-aero-rad_sec</input>
            <table>
                <independentVar>velocities/vc-kts</independentVar>
                <tableData>
                    0   0
                    80  0
                    120	3.6251
                    650 2
                    1000 1
                </tableData>
            </table>
       </scheduled_gain>

        <scheduled_gain name="fcs/yaw-damper-dmd">
            <input>fcs/yaw-damper-sum</input>
            <table>
                <independentVar>aero/qbar-psf</independentVar>
                <tableData>
                    2.9900	0.0000
                    3.0000	1.0000
                </tableData>
            </table>
            <gain>fcs/yaw-damper-active</gain>
        </scheduled_gain>

        <fcs_function>
            <function>
                <product>
                    <min>
                        <max>
                            <product>
                                <sum>
                                    <p>fcs/rudder-cmd-norm</p>
                                    <p>fcs/yaw-damper-dmd</p>
                                    <p>fcs/yaw-trim-cmd-norm</p>
                                </sum>
                                <p>systems/cadc/rudder-effectivity</p>
                            </product>
                            <v>-1</v>
                        </max>
                        <v>1</v>
                    </min>
                    <sum>
                        <product>
                            <p>gear/gear-cmd-norm</p>
                            <v>0.7</v>
                        </product>
                        <v>0.3</v>
                    </sum>
                    <!--<property>fcs/pitch-ratio</property>-->
                    <!--<v>-1</v>-->
                </product>
            </function>
            <output>fcs/rudder-sum</output>
        </fcs_function>


        <switch name="fcs/rudder-actuator-pos">
            <default value="fcs/rudder-sum"/>
            <!--<test value="fcs/rudder-actuator-pos">
                systems/hydraulics/system-pressure eq 0
            </test>-->
            <test value="fcs/rudder-actuator-pos">
                malfunctions/fcs/rudder-actuator-inop ne 0
            </test>
        </switch>
        <kinematic name="Rudder Control">
            <input>fcs/rudder-actuator-pos</input>
            <traverse>
                <setting>
                    <position>-0.35</position>
                    <time>0.90</time>
                    <!-- based on 30 deg/sec -->
                </setting>
                <setting>
                    <position>0.35</position>
                    <time>0.90</time>
                    <!-- based on 30 deg/sec -->
                </setting>
            </traverse>
            <output>fcs/rudder-pos-rad</output>
        </kinematic>

        <aerosurface_scale name="rudder normalization">
            <input>fcs/rudder-pos-rad</input>
            <domain>
                <min> -0.35 </min>
                <max>  0.35 </max>
            </domain>
            <range>
                <min> -1 </min>
                <max>  1 </max>
            </range>
            <output>fcs/rudder-pos-norm</output>
        </aerosurface_scale>
    </channel>

    <channel name="Landing Gear">
<!-- landing gear;
1. Switch up down
2. emergency handle

- normal operation (emergency handle retracted).
  : requires hyds
  : cannot retract on ground
  
  parts:
    uplock
    downlock
    door
    bogeys
    
    uplock downlock modelled as single lock -ve for downlock 0 for unlocked, 1 for uplocked
    
emerg operation.
: handle pulled. hyds & electrics cut
-->
        <!--<pure_gain name="gear/unit[0]/pos-norm">
            <description>Landing gear unit 0 position</description>
            <input>gear/gear-pos-norm</input>
            <gain> 1</gain>
        </pure_gain>
        <pure_gain name="gear/unit[1]/pos-norm">
            <description>Landing gear unit 0 position</description>
            <input>gear/gear-pos-norm</input>
            <gain> 1</gain>
        </pure_gain>
        <pure_gain name="gear/unit[2]/pos-norm">
            <description>Landing gear unit 0 position</description>
            <input>gear/gear-pos-norm</input>
            <gain> 1</gain>
        </pure_gain>-->

        <!-- Deplete the JFS store-->
        <switch name="systems/hydraulics/emerg-gear-unlocked">
            <default value="0"/>
            <test value="1">
                systems/hydraulics/landing-gear-standby-accumulator-psi gt 200
                gear/emergency-handle gt 0.7
                gear/unit[0]/locked ne 0
            </test>
            <test value="systems/hydraulics/emerg-gear-unlocked">
                gear/emergency-handle gt 0.7
            </test>            
        </switch>
        <switch name="systems/hydraulics/emerg-gear-bleed">
            <default value="0"/>
            <test value="10000">
                systems/hydraulics/emerg-gear-unlocked ne 0
                gear/unit[0]/locked ne 0
            </test>
        </switch>
        <switch name="gear/emerg-pos">
            <default value="gear/emerg-pos-dmd"/>
        </switch>

        <switch name="gear/unit[0]/locked">
            <default value="-1"/>
            <test value="0">
                systems/hydraulics/emerg-gear-unlocked ne 0
                <!-- unlocked when handle pulled -->
                gear/emergency-handle gt 0.7
                gear/emerg-pos lt 1
            </test>
            <test value="0">
                <!-- unlocked. -->
               gear/gear-pos-norm gt 0
               gear/gear-pos-norm lt 1
            </test>
            <test value="1">
               gear/gear-pos-norm le 0
            </test>
            <test value="-1">
               gear/gear-pos-norm ge 1
            </test>
        </switch>
        <switch name="gear/unit[1]/locked">
            <default value="-1"/>
            <test value="0">
                <!-- unlocked when handle pulled -->
                <!-- should deplete the JFS store-->
                gear/emergency-handle gt 0.7
                gear/emerg-pos lt 1
            </test>
            <test value="0">
                <!-- unlocked. -->
               gear/gear-pos-norm gt 0
               gear/gear-pos-norm lt 1
            </test>
            <test value="1">
               gear/gear-pos-norm le 0
            </test>
            <test value="-1">
               gear/gear-pos-norm ge 1
            </test>
        </switch>
        <switch name="gear/unit[2]/locked">
            <default value="-1"/>
            <test value="0">
                <!-- unlocked when handle pulled -->
                <!-- should deplete the JFS store-->
                gear/emergency-handle gt 0.7
                gear/emerg-pos lt 1
            </test>
            <test value="0">
                <!-- unlocked. -->
               gear/gear-pos-norm gt 0
               gear/gear-pos-norm lt 1
            </test>
            <test value="1">
               gear/gear-pos-norm le 0
            </test>
            <test value="-1">
               gear/gear-pos-norm ge 1
            </test>
        </switch>
        <fcs_function name="gear/emerg-pos-dmd">
            <function>
                <ifthen>
                    <and>
                        <ge>
                            <property>gear/emergency-handle</property>
                            <value>0.9</value>
                        </ge>
                        <or>
                            <eq>
                                <property>gear/unit[0]/locked</property>
                                <value>-1.0</value>
                            </eq>
                            <and>
                                <eq>
                                    <property>contact/unit[9]/WOW</property>
                                    <value>0</value>
                                </eq>
                                <eq>
                                    <property>contact/unit[10]/WOW</property>
                                    <value>0</value>
                                </eq>
                            </and>
                        </or>
                    </and>
                    <sum>
                        <property>gear/emerg-pos</property>
                        <ifthen><not><property>gear/unit[0]/locked</property></not>
                            <table>
                                <independentVar lookup="row">gear/emerg-pos</independentVar>
                                <independentVar lookup="column">accelerations/Nz</independentVar>
                                <tableData>
                                               -3.0     0.0     0.5     1.0     1.2     2.0     5.0    10.0
                                   -0.00001  0.00000 0.00100 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                    0.0     -0.00400 0.00000 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                    0.90     0.00000 0.00000 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                    0.98     0.11000 0.00000 0.00000 0.00000 0.00000 0.09000 0.11090 0.00400
                                    1.0      0.00000 0.00000 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                </tableData>
                            </table>
                            <value>0</value>
                    </ifthen>
                    </sum>
                    <value>0</value>
                </ifthen>
            </function>
        </fcs_function>
        <switch name="gear/gear-dmd-norm">
            <default value="1"/>
            <test value="1">
                <!-- always force gear down when on ground - to prevent inadvertant retraction -->
                position/aircraft-on-ground ne 0
            </test>
            <test value="gear/emerg-pos">
                gear/emergency-handle ne 0
            </test>
            <test value="gear/gear-pos-norm">
                gear/serviceable ne 1
                gear/emergency-handle lt 1
            </test>
            <test value="gear/gear-dmd-norm">
                systems/hydraulics/system-pressure eq 0
            </test>
            <test value="gear/gear-cmd-norm">
                systems/hydraulics/system-pressure ne 0
            </test>
            <clipto>
                <min> 0 </min>
                <max>  1 </max>
            </clipto>
            <output>gear/gear-dmd-norm</output>
        </switch>
        <kinematic name="Gear Control">
            <input>gear/gear-dmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     1.8 </time>
                </setting>
            </traverse>
            <output>gear/gear-pos-norm</output>
        </kinematic>

        <!--<kinematic name="fcs/steer-pos-deg">
            <input>fcs/steer-cmd-norm</input>
            <traverse>
                <setting>
                    <position>-35</position>
                    <time>1.1</time>
                </setting>
                <setting>
                    <position>35</position>
                    <time>1.1</time>
                </setting>
            </traverse>
            <output>fcs/steer-pos-deg</output>
        </kinematic>-->
    </channel>

    <channel name="Speedbrake">
        <switch name="fcs/speedbrake-dmd-norm">
            <default value="0"/>
            <test value="fcs/speedbrake-dmd-norm">
                systems/hydraulics/system-pressure eq 0
            </test>
            <test value="fcs/speedbrake-cmd-norm">
                systems/hydraulics/system-pressure ne 0
            </test>
            <clipto>
                <min> 0 </min>
                <max>  1 </max>
            </clipto>
            <output>fcs/speedbrake-dmd-norm</output>
        </switch>

        <kinematic name="Speedbrake Control">
            <input>fcs/speedbrake-dmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     1.5 </time>
                </setting>
            </traverse>
            <output>fcs/speedbrake-pos-norm</output>
        </kinematic>
    </channel>

<!--
    <channel name="Hook">
        <kinematic name="fcs/hook-control">
            <input>fcs/hook-engage</input>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>2.5</time>
                </setting>
            </traverse>
            <output>fcs/hook-pos-norm</output>
        </kinematic>
    </channel>
-->
    <channel name="Flaps">
        <switch name="fcs/flap-total-dmd">
            <default value="0"/>
            <test value="fcs/flap-total-dmd">
                systems/hydraulics/number1-system-pressure eq 0
            </test>
            <test value="fcs/flap-cmd-norm">
                fcs/flap-cmd-norm ne 0
                systems/hydraulics/number1-system-pressure ne 0
            </test>
            <clipto>
                <min> 0 </min>
                <max>  1 </max>
            </clipto>
            <output>fcs/flap-total-dmd</output>
        </switch>

        <kinematic name="Flaps Control">
            <input>fcs/flap-total-dmd</input>
            <traverse>
                <setting>
                    <position>  0 </position>
                    <time>      0 </time>
                </setting>
                <setting>
                    <position> 45 </position>
                    <time>    1.9 </time>
                </setting>
            </traverse>
            <output>fcs/flap-pos-deg</output>
        </kinematic>

        <aerosurface_scale name="flap normalization">
            <input>fcs/flap-pos-deg</input>
            <domain>
                <min>  0 </min>
                <max> 50 </max>
            </domain>
            <range>
                <min> 0 </min>
                <max> 1 </max>
            </range>
            <output>fcs/flap-pos-norm</output>
        </aerosurface_scale>

        <fcs_function name="fcs/slat-total-dmd">
            <function>
                <ifthen>
                    <le>
                        <p>systems/hydraulics/number1-system-pressure</p>
                        <v>0</v>
                    </le>
                    <p>fcs/slat-total-dmd</p>
                    <ifthen>
                        <le>
                            <p>fcs/flap-cmd-norm</p>
                            <v>0.33</v>
                        </le>
                        <v>0</v>
                        <ifthen>
                            <ge>
                                <p>fcs/flap-cmd-norm</p>
                                <v>0.34</v>
                            </ge>
                            <v>1.0</v>
                            <v>0.5</v>
                        </ifthen>
                    </ifthen>
                </ifthen>
            </function>
        </fcs_function>

        <kinematic name="Slats Control">
            <input>fcs/slat-total-dmd</input>
            <traverse>
                <setting>
                    <position>  0 </position>
                    <time>      0 </time>
                </setting>
                <setting>
                    <position> 15 </position>
                    <time>    1.9 </time>
                </setting>
                <setting>
                    <position> 30 </position>
                    <time>    1.9 </time>
                </setting>
            </traverse>
            <output>fcs/slat-pos-deg</output>
        </kinematic>

        <aerosurface_scale name="slat normalization">
            <input>fcs/slat-pos-deg</input>
            <domain>
                <min>  0 </min>
                <max> 30 </max>
            </domain>
            <range>
                <min> 0 </min>
                <max> 1 </max>
            </range>
            <output>fcs/slat-pos-norm</output>
        </aerosurface_scale>
    </channel>

</system>
